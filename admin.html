
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel de Administra√ß√£o</title>
    <link rel="stylesheet" href="styles2.css" />
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            signOut,
        } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
        import {
            getFirestore,
            collection,
            query,
            where,
            getDocs,
            onSnapshot,
            doc,
            updateDoc,
            deleteDoc,
            orderBy,
            addDoc,
        } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD2abLi_zEjHPS0D8EvcDPYLIbOhQa68p8",
            authDomain: "projeto3-9bb85.firebaseapp.com",
            projectId: "projeto3-9bb85",
            storageBucket: "projeto3-9bb85.firebasestorage.app",
            messagingSenderId: "403757642546",
            appId: "1:403757642546:web:b2093665bce9099b6fdd2b",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const adminContent = document.getElementById("admin-content");
        const accessDenied = document.getElementById("access-denied");
        const listaDeAgendamentosAdminDiv = document.getElementById("lista-de-agendamentos-admin");
        const modalEdicao = document.getElementById("modal-edicao");
        const formEditarAgendamento = document.getElementById("form-editar-agendamento");
        const editarAgendamentoIdInput = document.getElementById("editar-agendamento-id");
        const editarDataInput = document.getElementById("editar-data");
        const editarHorarioSelect = document.getElementById("editar-horario");
        const editarStatusSelect = document.getElementById("editar-status");
        const salvarEdicaoBtn = document.getElementById("salvar-edicao-btn");
        const cancelarEdicaoBtn = document.getElementById("cancelar-edicao-btn");
        const closeButtonEdicao = document.getElementById("close-button-edicao");
        const modalNovoAgendamento = document.getElementById("modal-novo-agendamento");
        const formNovoAgendamento = document.getElementById("form-novo-agendamento");
        const closeButtonNovo = document.getElementById("close-button-novo-agendamento");

        let agendamentosList = [];
        let usuariosList = [];

        const duracaoServicos = {
            "Manicure - P√© e M√£o": 120,
            "Manicure - M√£o Simples": 60,
            "P√© Simples": 75,
            "ESMALTA√á√ÉO EM GEL C/ Cutilagem": 75,
            "Esmalta√ß√£o M√£o": 75,
            "Alongamento Speed Tip Gel": 75,
            "PL√ÅSTICA DOS P√âS": 75,
            "Aplica√ß√£o Unha Posti√ßa": 75,
            "SPA DOS P√âS": 80
        };

        function criarCampoHorario(data = "", horario = "") {
            const container = document.createElement("div");
            container.classList.add("campo-horario");

            const uniqueId = `novo-horario-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

            container.innerHTML = `
                <div style="display: flex; gap: 10px; align-items: flex-end;">
                    <div>
                        <label for="novo-data-${uniqueId}">Data:</label>
                        <input type="date" class="novo-data" id="novo-data-${uniqueId}" value="${data}" required />
                    </div>
                    <div>
                        <label for="novo-horario-${uniqueId}">Hor√°rio:</label>
                        <select class="novo-horario" id="novo-horario-${uniqueId}" required>
                            <option value="">Selecione uma data primeiro</option>
                        </select>
                    </div>
                    <button type="button" class="adicionar-horario-abaixo">‚ûï</button>
                    <button type="button" class="remover-horario-btn">üóëÔ∏è</button>
                </div>
            `;

            const dataInput = container.querySelector(`#novo-data-${uniqueId}`);
            const horarioSelect = container.querySelector(`#novo-horario-${uniqueId}`);

            dataInput.addEventListener("change", async () => {
                const dataSelecionada = dataInput.value;
                if (dataSelecionada) {
                    const agendamentosNaData = await buscarAgendamentosPorData(dataSelecionada);
                    const horariosDisponiveis = gerarHorariosDisponiveis(dataSelecionada, agendamentosNaData, editarAgendamentoIdInput.value);

                    horarioSelect.innerHTML = '<option value="">Selecione um hor√°rio</option>';
                    horariosDisponiveis.forEach(horario => {
                        const option = document.createElement("option");
                        option.value = horario;
                        option.textContent = horario;
                        horarioSelect.appendChild(option);
                    });

                    if (horariosDisponiveis.length === 0) {
                        horarioSelect.innerHTML = '<option value="">Nenhum hor√°rio dispon√≠vel</option>';
                        horarioSelect.disabled = true;
                    } else {
                        horarioSelect.disabled = false;
                    }
                } else {
                    horarioSelect.innerHTML = '<option value="">Selecione uma data primeiro</option>';
                    horarioSelect.disabled = true;
                }
            });

            if (data) {
                dataInput.dispatchEvent(new Event("change"));
                if (horario) {
                    horarioSelect.value = horario;
                }
            }

            container.querySelector(".adicionar-horario-abaixo").addEventListener("click", () => {
                const novo = criarCampoHorario();
                container.insertAdjacentElement("afterend", novo);
            });

            container.querySelector(".remover-horario-btn").addEventListener("click", () => {
                container.remove();
            });

            return container;
        }

        async function verificarRoleAdmin(user) {
            if (user) {
                const userDocSnapshot = await getDocs(
                    query(collection(db, "users"), where("uid", "==", user.uid))
                );
                if (!userDocSnapshot.empty) {
                    const userData = userDocSnapshot.docs[0].data();
                    return userData.isAdmin === true;
                }
            }
            return false;
        }

        async function carregarUsuarios() {
            const usuariosRef = collection(db, "users");
            const querySnapshot = await getDocs(usuariosRef);
            usuariosList = [];
            querySnapshot.forEach((doc) => {
                usuariosList.push({ id: doc.id, ...doc.data() });
            });

            const usuarioSelect = document.getElementById("novo-usuario");
            usuarioSelect.innerHTML = '<option value="">Selecione um usu√°rio</option>';
            usuariosList.forEach((usuario) => {
                const option = document.createElement("option");
                option.value = usuario.uid;
                option.textContent = usuario.displayName || "Sem nome";
                usuarioSelect.appendChild(option);
            });
        }

        async function exibirAgendamentosAdmin(agendamentos, filtros = {}) {
            listaDeAgendamentosAdminDiv.innerHTML = "";

            let agendamentosFiltrados = [...agendamentos];

            if (filtros.dataInicio || filtros.dataFim) {
                const dataInicio = filtros.dataInicio
                    ? new Date(filtros.dataInicio)
                    : new Date(-8640000000000000);
                dataInicio.setHours(0, 0, 0, 0);
                const dataFim = filtros.dataFim
                    ? new Date(filtros.dataFim)
                    : new Date(8640000000000000);
                dataFim.setHours(23, 59, 59, 999);

                agendamentosFiltrados = agendamentosFiltrados.filter((agendamento) => {
                    const dataAgendamento = new Date(agendamento.data);
                    return dataAgendamento >= dataInicio && dataAgendamento <= dataFim;
                });
            }

            if (filtros.nome) {
                const nomeLower = filtros.nome.toLowerCase();
                const agendamentosComNomes = await Promise.all(
                    agendamentosFiltrados.map(async (agendamento) => {
                        try {
                            const userDoc = await getDocs(
                                query(collection(db, "users"), where("uid", "==", agendamento.uid))
                            );
                            const nomeUsuario = userDoc.empty
                                ? ""
                                : userDoc.docs[0].data().displayName || "";
                            return { ...agendamento, nomeUsuario };
                        } catch (error) {
                            console.error("Erro ao buscar nome do usu√°rio:", error);
                            return { ...agendamento, nomeUsuario: "" };
                        }
                    })
                );

                agendamentosFiltrados = agendamentosComNomes.filter((agendamento) =>
                    agendamento.nomeUsuario.toLowerCase().includes(nomeLower)
                );
            }

            if (agendamentosFiltrados.length > 0) {
                agendamentosFiltrados.sort((a, b) => {
                    const dateA = new Date(a.data);
                    const dateB = new Date(b.data);
                    return dateA - dateB;
                });

                for (const agendamento of agendamentosFiltrados) {
                    try {
                        const userDoc = await getDocs(
                            query(collection(db, "users"), where("uid", "==", agendamento.uid))
                        );

                        let nomeUsuario = "N√£o encontrado";
                        let telefoneUsuario = "N√£o encontrado";

                        if (!userDoc.empty) {
                            const userData = userDoc.docs[0].data();
                            nomeUsuario = userData.displayName || "N√£o informado";
                            telefoneUsuario = userData.phone || "N√£o informado";
                        }

                        const dataAgendada = new Date(agendamento.data);
                        const dataFormatada = dataAgendada.toLocaleDateString("pt-BR", {
                            day: "2-digit",
                            month: "2-digit",
                            year: "numeric",
                            hour: "2-digit",
                            minute: "2-digit",
                        });

                        const servicos = Array.isArray(agendamento.servicos)
                            ? agendamento.servicos.join(", ")
                            : "Nenhum servi√ßo selecionado";

                        const agendamentoDiv = document.createElement("div");
                        agendamentoDiv.classList.add("agendamento-item");
                        agendamentoDiv.innerHTML = `
                            <p><strong>Nome do Usu√°rio:</strong> ${nomeUsuario}</p>
                            <p><strong>Telefone do Usu√°rio:</strong> ${telefoneUsuario}</p>
                            <p><strong>Servi√ßos:</strong> ${servicos}</p>
                            <p><strong>Data e Hora:</strong> ${dataFormatada}</p>
                        `;

                        if (!agendamento.confirmacaoEnviada) {
                            agendamentoDiv.innerHTML += `
                                <button class="whatsapp-btn"
                                    data-id="${agendamento.id}"
                                    data-nome="${nomeUsuario}"
                                    data-telefone="${telefoneUsuario}"
                                    data-servicos="${servicos}"
                                    data-data="${dataFormatada}">
                                    Enviar Confirma√ß√£o por WhatsApp
                                </button>
                            `;
                        } else {
                            agendamentoDiv.innerHTML += `<p>Confirma√ß√£o j√° enviada.</p>`;
                        }

                        agendamentoDiv.innerHTML += `
                            <button class="editar-btn"
                                data-id="${agendamento.id}"
                                data-nome="${nomeUsuario}"
                                data-servicos='${JSON.stringify(agendamento.servicos)}'
                                data-data-real="${agendamento.data}">
                                Editar
                            </button>
                            <button class="excluir-btn" data-id="${agendamento.id}">
                                Excluir
                            </button>
                            <hr>
                        `;

                        listaDeAgendamentosAdminDiv.appendChild(agendamentoDiv);
                    } catch (error) {
                        console.error("Erro ao buscar dados do usu√°rio:", error);
                    }
                }

                document.querySelectorAll(".editar-btn").forEach((botao) => {
                    botao.addEventListener("click", async (event) => {
                        const agendamentoId = event.target.dataset.id;
                        const timestamp = parseInt(event.target.dataset.dataReal, 10);
                        const dataObj = new Date(timestamp);

                        if (isNaN(dataObj.getTime())) {
                            console.error("Data inv√°lida:", timestamp);
                            return;
                        }

                        editarAgendamentoIdInput.value = agendamentoId;
                        editarDataInput.value = dataObj.toISOString().slice(0, 10);
                        editarStatusSelect.value = "pendente";

                        const horaOriginal = `${dataObj.getHours().toString().padStart(2, '0')}:${dataObj.getMinutes().toString().padStart(2, '0')}`;

                        await atualizarHorariosDisponiveis(dataObj, agendamentoId);
                        editarHorarioSelect.value = horaOriginal;

                        if (!editarHorarioSelect.value) {
                            const option = document.createElement("option");
                            option.value = horaOriginal;
                            option.textContent = horaOriginal;
                            editarHorarioSelect.appendChild(option);
                            editarHorarioSelect.value = horaOriginal;
                        }

                        const container = document.getElementById("novos-horarios-container");
                        container.innerHTML = "";
                        container.appendChild(criarCampoHorario());

                        modalEdicao.style.display = "block";
                    });
                });

                document.querySelectorAll(".excluir-btn").forEach((botao) => {
                    botao.addEventListener("click", async (event) => {
                        const agendamentoId = event.target.dataset.id;

                        if (confirm("Tem certeza de que deseja excluir este agendamento?")) {
                            try {
                                const agendamentoRef = doc(db, "agendamentos", agendamentoId);
                                await deleteDoc(agendamentoRef);
                                alert("Agendamento exclu√≠do com sucesso!");
                            } catch (error) {
                                console.error("Erro ao excluir o agendamento:", error);
                                alert("Erro ao excluir o agendamento.");
                            }
                        }
                    });
                });

                document.querySelectorAll(".whatsapp-btn").forEach((botao) => {
                    botao.addEventListener("click", async () => {
                        const nome = botao.dataset.nome;
                        const telefone = botao.dataset.telefone.replace(/\D/g, "");
                        const servicos = botao.dataset.servicos;
                        const data = botao.dataset.data;
                        const agendamentoId = botao.dataset.id;

                        const mensagem = `Ol√° ${nome}, tudo bem? üëã\n\n Seu agendamento em Ateli√™ das Unhas foi confirmado!\nüìÖ Data: ${data}\nüíº Servi√ßos: ${servicos}\n\nQualquer d√∫vida, estamos √† disposi√ß√£o.üíÖ`;
                        const url = `https://wa.me/55${telefone}?text=${encodeURIComponent(mensagem)}`;
                        window.open(url, "_blank");

                        try {
                            const agendamentoRef = doc(db, "agendamentos", agendamentoId);
                            await updateDoc(agendamentoRef, {
                                confirmacaoEnviada: true,
                            });
                            console.log("Confirma√ß√£o enviada com sucesso!");
                        } catch (error) {
                            console.error("Erro ao atualizar o status de confirma√ß√£o:", error);
                        }
                    });
                });
            } else {
                listaDeAgendamentosAdminDiv.innerHTML = "<p>Nenhum agendamento encontrado com os filtros aplicados.</p>";
            }
        }

        async function buscarAgendamentosPorData(dataSelecionada) {
            const inicioDoDia = new Date(dataSelecionada);
            inicioDoDia.setHours(0, 0, 0, 0);
            const fimDoDia = new Date(dataSelecionada);
            fimDoDia.setHours(23, 59, 59, 999);

            const agendamentosRef = collection(db, "agendamentos");
            const q = query(
                agendamentosRef,
                where('data', '>=', inicioDoDia.toISOString()),
                where('data', '<=', fimDoDia.toISOString())
            );

            const querySnapshot = await getDocs(q);
            const agendamentosNaData = [];
            querySnapshot.forEach((doc) => {
                agendamentosNaData.push({ id: doc.id, ...doc.data() });
            });
            return agendamentosNaData;
        }

        function gerarHorariosDisponiveis(dataSelecionada, agendamentosNaData, agendamentoIdAtual, duracaoTotal) {
            const horariosFuncionamentoInicio = 8;
            const horariosFuncionamentoFim = 17;
            const intervaloAgendamentoMinutos = 15;
            const horariosPossiveis = [];
            const horariosOcupados = new Set();

            for (let hora = horariosFuncionamentoInicio; hora < horariosFuncionamentoFim; hora++) {
                for (let minuto = 0; minuto < 60; minuto += intervaloAgendamentoMinutos) {
                    const horario = `${hora.toString().padStart(2, '0')}:${minuto.toString().padStart(2, '0')}`;
                    horariosPossiveis.push(horario);
                }
            }

            let horarioOriginal = null;
            const agendamentoAtual = agendamentosNaData.find(ag => ag.id === agendamentoIdAtual);
            if (agendamentoAtual) {
                const dataOriginal = new Date(agendamentoAtual.data);
                horarioOriginal = `${dataOriginal.getHours().toString().padStart(2, '0')}:${dataOriginal.getMinutes().toString().padStart(2, '0')}`;
            }

            agendamentosNaData
                .filter(agendamento => agendamento.id !== agendamentoIdAtual)
                .forEach(agendamento => {
                    const inicio = new Date(agendamento.data);
                    let duracaoAgendamento = 0;
                    if (Array.isArray(agendamento.servicos)) {
                        agendamento.servicos.forEach(servico => {
                            duracaoAgendamento += duracaoServicos[servico] || 60;
                        });
                    } else {
                        duracaoAgendamento = 60;
                    }

                    const fim = new Date(inicio.getTime() + duracaoAgendamento * 60 * 1000);
                    let currentTime = new Date(inicio);
                    while (currentTime < fim) {
                        const horaFormatada = String(currentTime.getHours()).padStart(2, '0');
                        const minutoFormatada = String(currentTime.getMinutes()).padStart(2, '0');
                        horariosOcupados.add(`${horaFormatada}:${minutoFormatada}`);
                        currentTime.setMinutes(currentTime.getMinutes() + intervaloAgendamentoMinutos);
                    }
                });

            const horariosDisponiveis = [];
            horariosPossiveis.forEach(horario => {
                const [h, m] = horario.split(':').map(Number);
                const inicioAgendamento = new Date(dataSelecionada);
                inicioAgendamento.setHours(h, m, 0, 0);
                const fimAgendamento = new Date(inicioAgendamento.getTime() + duracaoTotal * 60 * 1000);

                let horarioLivre = true;
                let currentTime = new Date(inicioAgendamento);
                while (currentTime < fimAgendamento) {
                    const horaAtual = String(currentTime.getHours()).padStart(2, '0');
                    const minutoAtual = String(currentTime.getMinutes()).padStart(2, '0');
                    if (horariosOcupados.has(`${horaAtual}:${minutoAtual}`)) {
                        horarioLivre = false;
                        break;
                    }
                    currentTime.setMinutes(currentTime.getMinutes() + intervaloAgendamentoMinutos);
                }

                if (horarioLivre) {
                    horariosDisponiveis.push(horario);
                }
            });

            if (horarioOriginal && !horariosDisponiveis.includes(horarioOriginal)) {
                horariosDisponiveis.push(horarioOriginal);
                horariosDisponiveis.sort();
            }

            return horariosDisponiveis;
        }

        async function atualizarHorariosDisponiveis(dataSelecionada, agendamentoIdAtual, duracaoTotal) {
            const agendamentosNaData = await buscarAgendamentosPorData(dataSelecionada);
            const horariosDisponiveis = gerarHorariosDisponiveis(dataSelecionada, agendamentosNaData, agendamentoIdAtual, duracaoTotal);

            const horarioSelect = document.getElementById("editar-horario");
            horarioSelect.innerHTML = '<option value="">Selecione um hor√°rio</option>';
            horariosDisponiveis.forEach(horario => {
                const option = document.createElement("option");
                option.value = horario;
                option.textContent = horario;
                horarioSelect.appendChild(option);
            });

            if (horariosDisponiveis.length === 0) {
                horarioSelect.innerHTML = '<option value="">Nenhum hor√°rio dispon√≠vel</option>';
                horarioSelect.disabled = true;
            } else {
                horarioSelect.disabled = false;
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const isAdmin = await verificarRoleAdmin(user);
                if (isAdmin) {
                    adminContent.style.display = "block";
                    accessDenied.style.display = "none";
                    await carregarUsuarios();
                    const q = collection(db, "agendamentos");
                    onSnapshot(q, (querySnapshot) => {
                        agendamentosList = [];
                        querySnapshot.forEach((doc) =>
                            agendamentosList.push({ id: doc.id, ...doc.data() })
                        );
                        exibirAgendamentosAdmin(agendamentosList);
                    });
                } else {
                    adminContent.style.display = "none";
                    accessDenied.style.display = "block";
                }
            } else {
                window.location.href = "/index.html";
            }
        });

        document.addEventListener("DOMContentLoaded", () => {
            const logoutAdminBtn = document.getElementById("logout-admin-btn");
            if (logoutAdminBtn) {
                logoutAdminBtn.addEventListener("click", () => {
                    signOut(auth)
                        .then(() => {
                            window.location.href = "/AteliedasUnhas/";
                        })
                        .catch((error) => {
                            alert("Erro ao sair.");
                        });
                });
            }

            const aplicarFiltroBtn = document.getElementById("aplicar-filtro-btn");
            const limparFiltroBtn = document.getElementById("limpar-filtro-btn");

            if (aplicarFiltroBtn) {
                aplicarFiltroBtn.addEventListener("click", () => {
                    const dataInicio = document.getElementById("filtro-data-inicio").value;
                    const dataFim = document.getElementById("filtro-data-fim").value;
                    const nome = document.getElementById("filtro-nome").value.trim();

                    const filtros = {};
                    if (dataInicio) filtros.dataInicio = dataInicio;
                    if (dataFim) filtros.dataFim = dataFim;
                    if (nome) filtros.nome = nome;

                    exibirAgendamentosAdmin(agendamentosList, filtros);
                });
            }

            if (limparFiltroBtn) {
                limparFiltroBtn.addEventListener("click", () => {
                    document.getElementById("filtro-data-inicio").value = "";
                    document.getElementById("filtro-data-fim").value = "";
                    document.getElementById("filtro-nome").value = "";
                    exibirAgendamentosAdmin(agendamentosList);
                });
            }

            if (editarDataInput) {
                editarDataInput.addEventListener("change", async () => {
                    const dataSelecionada = editarDataInput.value;
                    if (dataSelecionada) {
                        await atualizarHorariosDisponiveis(new Date(dataSelecionada), editarAgendamentoIdInput.value, 0);
                    } else {
                        editarHorarioSelect.innerHTML = '<option value="">Selecione uma data primeiro</option>';
                        editarHorarioSelect.disabled = true;
                    }
                });
            }

            if (salvarEdicaoBtn) {
                salvarEdicaoBtn.addEventListener("click", async () => {
                    const agendamentoId = editarAgendamentoIdInput.value;
                    const dataSelecionada = editarDataInput.value;
                    const horarioSelecionado = editarHorarioSelect.value;
                    const novoStatus = editarStatusSelect.value;

                    if (!dataSelecionada || !horarioSelecionado) {
                        alert("Por favor, selecione uma data e um hor√°rio para o agendamento principal.");
                        return;
                    }

                    const [hora, minuto] = horarioSelecionado.split(":");
                    const novaData = new Date(dataSelecionada);
                    novaData.setHours(parseInt(hora), parseInt(minuto), 0, 0);

                    const novosHorarios = [];
                    const horarioContainers = document.querySelectorAll(".campo-horario");
                    for (const container of horarioContainers) {
                        const dataInput = container.querySelector(".novo-data").value;
                        const horarioSelect = container.querySelector(".novo-horario").value;

                        if (dataInput && horarioSelect) {
                            const [hora, minuto] = horarioSelect.split(":");
                            const dataHorario = new Date(dataInput);
                            dataHorario.setHours(parseInt(hora), parseInt(minuto), 0, 0);
                            novosHorarios.push(dataHorario.getTime());
                        }
                    }

                    try {
                        const agendamentoOriginal = agendamentosList.find(ag => ag.id === agendamentoId);
                        if (!agendamentoOriginal) throw new Error("Agendamento original n√£o encontrado.");

                        const agendamentoRef = doc(db, "agendamentos", agendamentoId);
                        await updateDoc(agendamentoRef, {
                            data: novaData.toISOString(),
                            status: novoStatus,
                        });

                        for (const horario of novosHorarios) {
                            await addDoc(collection(db, "agendamentos"), {
                                data: new Date(horario).toISOString(),
                                status: novoStatus,
                                confirmacaoEnviada: false,
                                servicos: agendamentoOriginal.servicos || [],
                                uid: agendamentoOriginal.uid || "",
                                createdAt: new Date().getTime(),
                            });
                        }

                        alert("Agendamento atualizado com sucesso!");
                        modalEdicao.style.display = "none";
                    } catch (error) {
                        console.error("Erro ao salvar agendamento:", error);
                        alert("Erro ao salvar o agendamento.");
                    }
                });
            }

            if (cancelarEdicaoBtn) {
                cancelarEdicaoBtn.addEventListener("click", () => {
                    modalEdicao.style.display = "none";
                });
            }

            if (closeButtonEdicao) {
                closeButtonEdicao.addEventListener("click", () => {
                    modalEdicao.style.display = "none";
                });
            }

            window.addEventListener("click", (event) => {
                if (event.target === modalEdicao) {
                    modalEdicao.style.display = "none";
                }
                if (event.target === modalNovoAgendamento) {
                    modalNovoAgendamento.style.display = "none";
                    formNovoAgendamento.reset();
                    const horarioSelect = document.getElementById("novo-horario");
                    horarioSelect.innerHTML = '<option value="">Selecione uma data primeiro</option>';
                }
            });

            const novoDataInput = document.getElementById("novo-data");
            if (novoDataInput) {
                novoDataInput.addEventListener("change", async () => {
                    const dataSelecionada = novoDataInput.value;
                    if (dataSelecionada) {
                        const servicosSelecionados = Array.from(
                            document.querySelectorAll(".novo-servico-checkbox:checked")
                        ).map(cb => cb.value);
                        let duracaoTotal = 0;
                        servicosSelecionados.forEach(servico => {
                            duracaoTotal += duracaoServicos[servico] || 60;
                        });
                        await atualizarHorariosDisponiveis(dataSelecionada, null, duracaoTotal);
                    } else {
                        const horarioSelect = document.getElementById("novo-horario");
                        horarioSelect.innerHTML = '<option value="">Selecione uma data primeiro</option>';
                        horarioSelect.disabled = true;
                    }
                });
            }

            if (formNovoAgendamento) {
                formNovoAgendamento.addEventListener("submit", async (e) => {
                    e.preventDefault();

                    const usuarioUid = document.getElementById("novo-usuario").value;
                    const servicosSelecionados = Array.from(
                        document.querySelectorAll(".novo-servico-checkbox:checked")
                    ).map(cb => cb.value);
                    const dataSelecionada = document.getElementById("novo-data").value;
                    const horarioSelecionado = document.getElementById("novo-horario").value;

                    if (!usuarioUid) {
                        alert("Selecione um usu√°rio.");
                        return;
                    }
                    if (servicosSelecionados.length === 0) {
                        alert("Selecione pelo menos um servi√ßo.");
                        return;
                    }
                    if (!dataSelecionada || !horarioSelecionado) {
                        alert("Selecione uma data e um hor√°rio.");
                        return;
                    }

                    const [hora, minuto] = horarioSelecionado.split(":");
                    const dataAgendamento = new Date(dataSelecionada);
                    dataAgendamento.setHours(parseInt(hora), parseInt(minuto), 0, 0);

                    const hoje = new Date();
                    if (dataAgendamento < hoje.setHours(0, 0, 0, 0)) {
                        alert("N√£o √© poss√≠vel agendar para uma data passada.");
                        return;
                    }

                    try {
                        const q = query(
                            collection(db, "agendamentos"),
                            where("data", "==", dataAgendamento.toISOString()),
                            where("status", "==", "pendente")
                        );
                        const querySnapshot = await getDocs(q);

                        if (!querySnapshot.empty) {
                            alert("O hor√°rio selecionado j√° est√° ocupado. Escolha outro hor√°rio.");
                            return;
                        }

                        await addDoc(collection(db, "agendamentos"), {
                            uid: usuarioUid,
                            servicos: servicosSelecionados,
                            data: dataAgendamento.toISOString(),
                            status: "pendente",
                            confirmacaoEnviada: false,
                            createdAt: new Date().getTime(),
                        });

                        alert("Agendamento criado com sucesso!");
                        formNovoAgendamento.reset();
                        const horarioSelect = document.getElementById("novo-horario");
                        horarioSelect.innerHTML = '<option value="">Selecione uma data primeiro</option>';
                        modalNovoAgendamento.style.display = "none";
                    } catch (error) {
                        console.error("Erro ao criar agendamento:", error);
                        alert("Erro ao criar o agendamento.");
                    }
                });
            }

            const cancelarNovoBtn = document.getElementById("cancelar-novo-btn");
            if (cancelarNovoBtn) {
                cancelarNovoBtn.addEventListener("click", () => {
                    modalNovoAgendamento.style.display = "none";
                    formNovoAgendamento.reset();
                    const horarioSelect = document.getElementById("novo-horario");
                    horarioSelect.innerHTML = '<option value="">Selecione uma data primeiro</option>';
                });
            }

            const abrirNovoAgendamentoBtn = document.getElementById("abrir-novo-agendamento");
            if (abrirNovoAgendamentoBtn) {
                abrirNovoAgendamentoBtn.addEventListener("click", () => {
                    modalNovoAgendamento.style.display = "block";
                });
            }

            if (closeButtonNovo) {
                closeButtonNovo.addEventListener("click", () => {
                    modalNovoAgendamento.style.display = "none";
                    formNovoAgendamento.reset();
                    const horarioSelect = document.getElementById("novo-horario");
                    horarioSelect.innerHTML = '<option value="">Selecione uma data primeiro</option>';
                });
            }
        });
    </script>
</head>
<body>
<div id="admin-content" style="display: none;">
    <h1>Painel de Administra√ß√£o</h1>
    <button id="logout-admin-btn">Sair</button>

    <h2>Lista de Agendamentos</h2>
    <div id="filtro-agendamentos">
        <h3>Filtrar Agendamentos</h3>
        <form id="form-filtro-agendamentos">
            <div>
                <label for="filtro-data-inicio">Data In√≠cio:</label>
                <input type="date" id="filtro-data-inicio" />
            </div>
            <div>
                <label for="filtro-data-fim">Data Fim:</label>
                <input type="date" id="filtro-data-fim" />
            </div>
            <div>
                <label for="filtro-nome">Nome do Usu√°rio:</label>
                <input type="text" id="filtro-nome" placeholder="Digite o nome" />
            </div>
            <button type="button" id="aplicar-filtro-btn">Aplicar Filtro</button>
            <button type="button" id="limpar-filtro-btn">Limpar Filtro</button>
        </form>
    </div>
    <button id="abrir-novo-agendamento">Novo Agendamento</button>
    <div id="lista-de-agendamentos-admin"></div>
</div>

<div id="modal-edicao" class="modal-edicao">
    <div class="modal-content-edicao">
        <span id="close-button-edicao" class="close-button-edicao">&times;</span>
        <div id="formulario-edicao-agendamento">
            <h3>Editar Agendamento</h3>
            <form id="form-editar-agendamento">
                <input type="hidden" id="editar-agendamento-id" />
                <div style="margin-bottom: 20px;">
                    <label for="editar-data" style="font-weight: bold;">üìÖ Data do Agendamento:</label><br
                    <input type="date" id="editar-data" style="margin-top: 5px;" required />
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="editar-horario" style="font-weight: bold;">üïí Hor√°rio Dispon√≠vel:</label><br />
                    <select id="editar-horario" style="margin-top: 5px; padding: 5px;" required>
                        <option value="">Selecione uma data primeiro</option>
                    </select>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="font-weight: bold;">‚ûï Adicionar Novos Hor√°rios para Pacotes:</label>
                    <div id="novos-horarios-container" style="margin-top: 10px;"></div>
                </div>
                <div>
                    <label for="editar-status">Status:</label>
                    <select id="editar-status">
                        <option value="pendente">Pendente</option>
                        <option value="confirmado">Confirmado</option>
                    </select>
                </div>
                <button type="button" id="salvar-edicao-btn">Salvar Edi√ß√£o</button>
                <button type="button" id="cancelar-edicao-btn">Cancelar</button>
            </form>
        </div>
    </div>
</div>

<div id="modal-novo-agendamento" class="modal-novo-agendamento">
    <div class="modal-content-novo-agendamento">
        <span id="close-button-novo-agendamento" class="close-button-novo-agendamento">&times;</span>
        <div id="formulario-novo-agendamento">
            <h2>Novo Agendamento</h2>
            <form id="form-novo-agendamento">
                <div style="margin-bottom: 20px;">
                    <label for="novo-usuario">Usu√°rio:</label>
                    <select id="novo-usuario" required>
                        <option value="">Selecione um usu√°rio</option>
                    </select>
                </div>
                <div style="margin-bottom: 20px;">
                    <label>Servi√ßos:</label>
                    <div style="display: flex; flex-direction: column;">
                        <label><input type="checkbox" class="novo-servico-checkbox" value="Manicure - P√© e M√£o"> Manicure - P√© e M√£o</label>
                        <label><input type="checkbox" class="novo-servico-checkbox" value="Manicure - M√£o Simples"> Manicure - M√£o Simples</label>
                        <label><input type="checkbox" class="novo-servico-checkbox" value="P√© Simples"> P√© Simples</label>
                        <label><input type="checkbox" class="novo-servico-checkbox" value="ESMALTA√á√ÉO EM GEL C/ Cutilagem"> ESMALTA√á√ÉO EM GEL C/ Cutilagem</label>
                        <label><input type="checkbox" class="novo-servico-checkbox" value="Esmalta√ß√£o M√£o"> Esmalta√ß√£o M√£o</label>
                        <label><input type="checkbox" class="novo-servico-checkbox" value="Alongamento Speed Tip Gel"> Alongamento Speed Tip Gel</label>
                        <label><input type="checkbox" class="novo-servico-checkbox" value="PL√ÅSTICA DOS P√âS"> PL√ÅSTICA DOS P√âS</label>
                        <label><input type="checkbox" class="novo-servico-checkbox" value="Aplica√ß√£o Unha Posti√ßa"> Aplica√ß√£o Unha Posti√ßa</label>
                        <label><input type="checkbox" class="novo-servico-checkbox" value="SPA DOS P√âS"> SPA DOS P√âS</label>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="novo-data">Data:</label>
                    <input type="date" id="novo-data" required />
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="novo-horario">Hor√°rio:</label>
                    <select id="novo-horario" required>
                        <option value="">Selecione uma data primeiro</option>
                    </select>
                </div>
                <button type="submit">Criar Agendamento</button>
                <button type="button" id="cancelar-novo-btn">Cancelar</button>
            </form>
        </div>
    </div>
</div>

<div id="access-denied" style="display: none;">
    <h1>Acesso Negado</h1>
    <p>Voc√™ n√£o tem permiss√£o para acessar esta p√°gina.</p>
    <p><a href="/index.html">Voltar para a p√°gina inicial</a></p>
</div>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9330e1833c7fc006',t:'MTc0NTExMjY3My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9335d3be7d5cbfed',t:'MTc0NTE2NDUzOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9336cea5db68673d',t:'MTc0NTE3NDgxNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>