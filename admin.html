<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel de Administra√ß√£o</title>
    <link rel="stylesheet" href="styles2.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            signOut,
        } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
        import {
            getFirestore,
            collection,
            query,
            where,
            getDocs,
            onSnapshot,
            doc,
            updateDoc,
            deleteDoc,
            addDoc,
        } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD2abLi_zEjHPS0D8EvcDPYLIbOhQa68p8",
            authDomain: "projeto3-9bb85.firebaseapp.com",
            projectId: "projeto3-9bb85",
            storageBucket: "projeto3-9bb85.firebasestorage.app",
            messagingSenderId: "403757642546",
            appId: "1:403757642546:web:b2093665bce9099b6fdd2b",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const adminContent = document.getElementById("admin-content");
        const accessDenied = document.getElementById("access-denied");
        const listaDeAgendamentosAdminDiv = document.getElementById("lista-de-agendamentos-admin");
        const modalEdicao = document.getElementById("modal-edicao");
        const formEditarAgendamento = document.getElementById("form-editar-agendamento");
        const editarAgendamentoIdInput = document.getElementById("editar-agendamento-id");
        const editarDataInput = document.getElementById("editar-data");
        const editarHorarioSelect = document.getElementById("editar-horario");
        const editarStatusSelect = document.getElementById("editar-status");
        const salvarEdicaoBtn = document.getElementById("salvar-edicao-btn");
        const cancelarEdicaoBtn = document.getElementById("cancelar-edicao-btn");
        const closeButtonEdicao = document.getElementById("close-button-edicao");
        const modalNovoAgendamento = document.getElementById("modal-novo-agendamento");
        const formNovoAgendamento = document.getElementById("form-novo-agendamento");
        const closeButtonNovo = document.getElementById("close-button-novo-agendamento");

        let agendamentosList = [];
        let usuariosList = [];

        const duracaoServicos = {
            "Manicure - P√© e M√£o": 120,
            "Manicure - M√£o Simples": 60,
            "P√© Simples": 75,
            "ESMALTA√á√ÉO EM GEL C/ Cutilagem": 75,
            "Esmalta√ß√£o M√£o": 75,
            "Alongamento Speed Tip Gel": 75,
            "PL√ÅSTICA DOS P√âS": 75,
            "Aplica√ß√£o Unha Posti√ßa": 75,
            "SPA DOS P√âS": 80
        };

        const precosServicos = {
            "Manicure - P√© e M√£o": 80,
            "Manicure - M√£o Simples": 35,
            "P√© Simples": 45,
            "ESMALTA√á√ÉO EM GEL C/ Cutilagem": 60,
            "Esmalta√ß√£o M√£o": 40,
            "Alongamento Speed Tip Gel": 120,
            "PL√ÅSTICA DOS P√âS": 70,
            "Aplica√ß√£o Unha Posti√ßa": 50,
            "SPA DOS P√âS": 65
        };

        async function verificarRoleAdmin(user) {
            if (user) {
                const userDocSnapshot = await getDocs(
                    query(collection(db, "users"), where("uid", "==", user.uid))
                );
                if (!userDocSnapshot.empty) {
                    const userData = userDocSnapshot.docs[0].data();
                    return userData.isAdmin === true;
                }
            }
            return false;
        }

        async function carregarUsuarios() {
            const usuariosRef = collection(db, "users");
            const querySnapshot = await getDocs(usuariosRef);
            usuariosList = [];
            querySnapshot.forEach((doc) => {
                usuariosList.push({ id: doc.id, ...doc.data() });
            });

            const usuarioSelect = document.getElementById("novo-usuario");
            usuarioSelect.innerHTML = '<option value="">Selecione um usu√°rio</option>';
            usuariosList.forEach((usuario) => {
                const option = document.createElement("option");
                option.value = usuario.uid;
                option.textContent = usuario.displayName || "Sem nome";
                usuarioSelect.appendChild(option);
            });
        }

        async function exibirAgendamentosAdmin(agendamentos, filtros = {}) {
            listaDeAgendamentosAdminDiv.innerHTML = "";

            let agendamentosFiltrados = [...agendamentos];

            if (filtros.dataInicio || filtros.dataFim) {
                const dataInicio = filtros.dataInicio
                    ? new Date(filtros.dataInicio)
                    : new Date(-8640000000000000);
                dataInicio.setHours(0, 0, 0, 0);
                const dataFim = filtros.dataFim
                    ? new Date(filtros.dataFim)
                    : new Date(8640000000000000);
                dataFim.setHours(23, 59, 59, 999);

                agendamentosFiltrados = agendamentosFiltrados.filter((agendamento) => {
                    const dataAgendamento = new Date(agendamento.data);
                    return dataAgendamento >= dataInicio && dataAgendamento <= dataFim;
                });
            }

            if (filtros.nome) {
                const nomeLower = filtros.nome.toLowerCase();
                const agendamentosComNomes = await Promise.all(
                    agendamentosFiltrados.map(async (agendamento) => {
                        try {
                            const userDoc = await getDocs(
                                query(collection(db, "users"), where("uid", "==", agendamento.uid))
                            );
                            const nomeUsuario = userDoc.empty
                                ? ""
                                : userDoc.docs[0].data().displayName || "";
                            return { ...agendamento, nomeUsuario };
                        } catch (error) {
                            console.error("Erro ao buscar nome do usu√°rio:", error);
                            return { ...agendamento, nomeUsuario: "" };
                        }
                    })
                );

                agendamentosFiltrados = agendamentosComNomes.filter((agendamento) =>
                    agendamento.nomeUsuario.toLowerCase().includes(nomeLower)
                );
            }

            if (agendamentosFiltrados.length > 0) {
                agendamentosFiltrados.sort((a, b) => {
                    const dateA = new Date(a.data);
                    const dateB = new Date(b.data);
                    return dateA - dateB;
                });

                for (const agendamento of agendamentosFiltrados) {
                    try {
                        const userDoc = await getDocs(
                            query(collection(db, "users"), where("uid", "==", agendamento.uid))
                        );

                        let nomeUsuario = "N√£o encontrado";
                        let telefoneUsuario = "N√£o encontrado";

                        if (!userDoc.empty) {
                            const userData = userDoc.docs[0].data();
                            nomeUsuario = userData.displayName || "N√£o informado";
                            telefoneUsuario = userData.phone || "N√£o informado";
                        }

                        const dataAgendada = new Date(agendamento.data);
                        const dataFormatada = dataAgendada.toLocaleDateString("pt-BR", {
                            day: "2-digit",
                            month: "2-digit",
                            year: "numeric",
                            hour: "2-digit",
                            minute: "2-digit",
                        });

                        const servicos = Array.isArray(agendamento.servicos)
                            ? agendamento.servicos.join(", ")
                            : "Nenhum servi√ßo selecionado";

                        const agendamentoDiv = document.createElement("div");
                        agendamentoDiv.classList.add("agendamento-item");
                        agendamentoDiv.innerHTML = `
                            <p><strong>Nome do Usu√°rio:</strong> ${nomeUsuario}</p>
                            <p><strong>Telefone do Usu√°rio:</strong> ${telefoneUsuario}</p>
                            <p><strong>Servi√ßos:</strong> ${servicos}</p>
                            <p><strong>Data e Hora:</strong> ${dataFormatada}</p>
                        `;

                        if (!agendamento.confirmacaoEnviada) {
                            agendamentoDiv.innerHTML += `
                                <button class="whatsapp-btn"
                                    data-id="${agendamento.id}"
                                    data-nome="${nomeUsuario}"
                                    data-telefone="${telefoneUsuario}"
                                    data-servicos="${servicos}"
                                    data-data="${dataFormatada}">
                                    Enviar Confirma√ß√£o por WhatsApp
                                </button>
                            `;
                        } else {
                            agendamentoDiv.innerHTML += `<p>Confirma√ß√£o j√° enviada.</p>`;
                        }

                        agendamentoDiv.innerHTML += `
                            <button class="editar-btn"
                                data-id="${agendamento.id}"
                                data-nome="${nomeUsuario}"
                                data-servicos='${JSON.stringify(agendamento.servicos)}'
                                data-data-real="${new Date(agendamento.data).getTime()}">
                                Editar
                            </button>
                            <button class="excluir-btn" data-id="${agendamento.id}">
                                Excluir
                            </button>
                            <hr>
                        `;

                        listaDeAgendamentosAdminDiv.appendChild(agendamentoDiv);
                    } catch (error) {
                        console.error("Erro ao buscar dados do usu√°rio:", error);
                    }
                }

                document.querySelectorAll(".editar-btn").forEach((botao) => {
                    botao.addEventListener("click", async (event) => {
                        const agendamentoId = event.target.dataset.id;
                        const dataReal = event.target.dataset.dataReal;
                        const dataObj = new Date(parseInt(dataReal, 10));

                        if (isNaN(dataObj.getTime())) {
                            console.error("Data inv√°lida:", dataReal);
                            return;
                        }

                        editarAgendamentoIdInput.value = agendamentoId;
                        editarDataInput.value = dataObj.toISOString().slice(0, 10);
                        editarStatusSelect.value = "pendente";

                        const agendamento = agendamentosList.find(ag => ag.id === agendamentoId);
                        let duracaoTotal = 0;
                        if (agendamento && Array.isArray(agendamento.servicos)) {
                            duracaoTotal = agendamento.servicos.reduce((total, servico) => {
                                return total + (duracaoServicos[servico] || 60);
                            }, 0);
                        } else {
                            duracaoTotal = 60; // Dura√ß√£o padr√£o
                        }
                        console.log("Dura√ß√£o total para edi√ß√£o:", duracaoTotal);

                        await atualizarHorariosDisponiveis(dataObj, agendamentoId, duracaoTotal, false);
                        modalEdicao.style.display = "block";
                    });
                });

                document.querySelectorAll(".excluir-btn").forEach((botao) => {
                    botao.addEventListener("click", async (event) => {
                        const agendamentoId = event.target.dataset.id;

                        if (confirm("Tem certeza de que deseja excluir este agendamento?")) {
                            try {
                                const agendamentoRef = doc(db, "agendamentos", agendamentoId);
                                await deleteDoc(agendamentoRef);
                                alert("Agendamento exclu√≠do com sucesso!");
                            } catch (error) {
                                console.error("Erro ao excluir o agendamento:", error);
                                alert("Erro ao excluir o agendamento.");
                            }
                        }
                    });
                });

                document.querySelectorAll(".whatsapp-btn").forEach((botao) => {
                    botao.addEventListener("click", async () => {
                        const nome = botao.dataset.nome;
                        const telefone = botao.dataset.telefone.replace(/\D/g, "");
                        const servicos = botao.dataset.servicos;
                        const data = botao.dataset.data;
                        const agendamentoId = botao.dataset.id;

                        const mensagem = `Ol√° ${nome}, tudo bem? üëã\n\n Seu agendamento em Ateli√™ das Unhas foi confirmado!\nüìÖ Data: ${data}\nüíº Servi√ßos: ${servicos}\n\nQualquer d√∫vida, estamos √† disposi√ß√£o.üíÖ`;
                        const url = `https://wa.me/55${telefone}?text=${encodeURIComponent(mensagem)}`;
                        window.open(url, "_blank");

                        try {
                            const agendamentoRef = doc(db, "agendamentos", agendamentoId);
                            await updateDoc(agendamentoRef, {
                                confirmacaoEnviada: true,
                            });
                            console.log("Confirma√ß√£o enviada com sucesso!");
                        } catch (error) {
                            console.error("Erro ao atualizar o status de confirma√ß√£o:", error);
                        }
                    });
                });
            } else {
                listaDeAgendamentosAdminDiv.innerHTML = "<p>Nenhum agendamento encontrado com os filtros aplicados.</p>";
            }
        }

        async function buscarAgendamentosPorData(dataSelecionada) {
            try {
                const inicioDoDia = new Date(dataSelecionada);
                inicioDoDia.setHours(0, 0, 0, 0);
                const fimDoDia = new Date(dataSelecionada);
                fimDoDia.setHours(23, 59, 59, 999);

                const agendamentosRef = collection(db, "agendamentos");
                const q = query(
                    agendamentosRef,
                    where('data', '>=', inicioDoDia.toISOString()),
                    where('data', '<=', fimDoDia.toISOString())
                );

                const querySnapshot = await getDocs(q);
                const agendamentosNaData = [];
                querySnapshot.forEach((doc) => {
                    agendamentosNaData.push({ id: doc.id, ...doc.data() });
                });
                console.log("Agendamentos encontrados na data:", agendamentosNaData);
                return agendamentosNaData;
            } catch (error) {
                console.error("Erro ao buscar agendamentos:", error);
                return [];
            }
        }

        async function isDataBloqueada(dataSelecionada) {
            const data = new Date(dataSelecionada);
            data.setHours(0, 0, 0, 0);
            const dataString = data.toISOString().split('T')[0];

            const bloqueiosRef = collection(db, "datas_bloqueadas");
            const q = query(bloqueiosRef, where("data", "==", dataString));
            const querySnapshot = await getDocs(q);
            return !querySnapshot.empty;
        }

        async function bloquearData(dataSelecionada) {
            try {
                const data = new Date(dataSelecionada);
                data.setHours(0, 0, 0, 0);
                const dataString = data.toISOString().split('T')[0];

                const agendamentosNaData = await buscarAgendamentosPorData(data);
                if (agendamentosNaData.length > 0) {
                    alert("N√£o √© poss√≠vel bloquear esta data, pois j√° existem agendamentos marcados.");
                    return false;
                }

                if (await isDataBloqueada(data)) {
                    alert("Esta data j√° est√° bloqueada.");
                    return false;
                }

                await addDoc(collection(db, "datas_bloqueadas"), {
                    data: dataString,
                    createdAt: new Date().getTime(),
                });

                alert("Data bloqueada com sucesso!");
                return true;
            } catch (error) {
                console.error("Erro ao bloquear data:", error);
                alert("Erro ao bloquear a data.");
                return false;
            }
        }

        function gerarHorariosDisponiveis(dataSelecionada, agendamentosNaData, agendamentoIdAtual, duracaoTotal) {
            const horariosFuncionamentoInicio = 8;
            const horariosFuncionamentoFim = 17;
            const intervaloAgendamentoMinutos = 15;
            const horariosDisponiveis = [];

            console.log("Gerando hor√°rios dispon√≠veis para:", dataSelecionada, "Dura√ß√£o:", duracaoTotal, "ID atual:", agendamentoIdAtual);

            for (let hora = horariosFuncionamentoInicio; hora < horariosFuncionamentoFim; hora++) {
                for (let minuto = 0; minuto < 60; minuto += intervaloAgendamentoMinutos) {
                    const horario = `${hora.toString().padStart(2, '0')}:${minuto.toString().padStart(2, '0')}`;
                    const inicioAgendamento = new Date(dataSelecionada);
                    inicioAgendamento.setHours(hora, minuto, 0, 0);
                    const fimAgendamento = new Date(inicioAgendamento.getTime() + duracaoTotal * 60 * 1000);

                    const horaFim = fimAgendamento.getHours() + fimAgendamento.getMinutes() / 60;
                    if (horaFim > horariosFuncionamentoFim) {
                        console.log(`Hor√°rio ${horario} descartado: ultrapassa hor√°rio de funcionamento (${horaFim} > ${horariosFuncionamentoFim})`);
                        continue;
                    }

                    let horarioLivre = true;
                    for (const agendamento of agendamentosNaData) {
                        if (agendamento.id === agendamentoIdAtual) {
                            console.log(`Ignorando agendamento atual ID: ${agendamentoIdAtual}`);
                            continue;
                        }

                        const inicioExistente = new Date(agendamento.data);
                        let duracaoExistente = 0;
                        if (Array.isArray(agendamento.servicos)) {
                            duracaoExistente = agendamento.servicos.reduce((total, servico) => {
                                return total + (duracaoServicos[servico] || 60);
                            }, 0);
                        } else {
                            duracaoExistente = 60;
                        }
                        const fimExistente = new Date(inicioExistente.getTime() + duracaoExistente * 60 * 1000);

                        if (inicioAgendamento < fimExistente && fimAgendamento > inicioExistente) {
                            horarioLivre = false;
                            console.log(`Conflito em ${horario}: Sobreposi√ß√£o com agendamento ID ${agendamento.id} (${inicioExistente.toLocaleTimeString()} - ${fimExistente.toLocaleTimeString()})`);
                            break;
                        }
                    }

                    if (horarioLivre) {
                        horariosDisponiveis.push(horario);
                        console.log(`Hor√°rio ${horario} adicionado como dispon√≠vel`);
                    }
                }
            }

            return horariosDisponiveis;
        }

        async function atualizarHorariosDisponiveis(dataSelecionada, agendamentoIdAtual, duracaoTotal, isNovoAgendamento = false) {
            console.log("Atualizando hor√°rios para:", dataSelecionada, "Dura√ß√£o:", duracaoTotal, "ID:", agendamentoIdAtual, "Novo:", isNovoAgendamento);

            let data = dataSelecionada instanceof Date ? dataSelecionada : new Date(dataSelecionada);
            if (isNaN(data.getTime())) {
                console.error("Data inv√°lida fornecida:", dataSelecionada);
                return;
            }
            data.setHours(0, 0, 0, 0);

            if (await isDataBloqueada(data)) {
                const horarioSelect = document.getElementById(isNovoAgendamento ? "novo-horario" : "editar-horario");
                horarioSelect.innerHTML = '<option value="">Data bloqueada</option>';
                horarioSelect.disabled = true;
                console.log("Data bloqueada:", data);
                return;
            }

            const agendamentosNaData = await buscarAgendamentosPorData(data);
            const horariosDisponiveis = gerarHorariosDisponiveis(data, agendamentosNaData, agendamentoIdAtual, duracaoTotal);

            const horarioSelect = document.getElementById(isNovoAgendamento ? "novo-horario" : "editar-horario");
            horarioSelect.innerHTML = '<option value="">Selecione um hor√°rio</option>';

            if (horariosDisponiveis.length === 0) {
                horarioSelect.innerHTML = '<option value="">Nenhum hor√°rio dispon√≠vel</option>';
                horarioSelect.disabled = true;
                console.log("Nenhum hor√°rio dispon√≠vel para a data selecionada");
            } else {
                horariosDisponiveis.forEach(horario => {
                    const option = document.createElement("option");
                    option.value = horario;
                    option.textContent = horario;
                    horarioSelect.appendChild(option);
                });
                horarioSelect.disabled = false;
                console.log("Hor√°rios dispon√≠veis adicionados:", horariosDisponiveis);
            }
        }

        async function gerarRelatorios(dataInicio, dataFim) {
            const inicio = dataInicio ? new Date(dataInicio) : new Date(-8640000000000000);
            inicio.setHours(0, 0, 0, 0);
            const fim = dataFim ? new Date(dataFim) : new Date(8640000000000000);
            fim.setHours(23, 59, 59, 999);

            const agendamentosRef = collection(db, "agendamentos");
            const q = query(
                agendamentosRef,
                where("data", ">=", inicio.toISOString()),
                where("data", "<=", fim.toISOString())
            );
            const querySnapshot = await getDocs(q);

            const agendamentosPorDia = {};
            const servicosContagem = {};
            let totalValorServicos = 0;

            querySnapshot.forEach(doc => {
                const agendamento = doc.data();
                const data = new Date(agendamento.data);
                const dataStr = data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });

                agendamentosPorDia[dataStr] = (agendamentosPorDia[dataStr] || 0) + 1;

                if (Array.isArray(agendamento.servicos)) {
                    agendamento.servicos.forEach(servico => {
                        servicosContagem[servico] = (servicosContagem[servico] || 0) + 1;
                        totalValorServicos += precosServicos[servico] || 0;
                    });
                }
            });

            const labels = Object.keys(agendamentosPorDia).sort((a, b) => {
                const [dayA, monthA, yearA] = a.split('/').map(Number);
                const [dayB, monthB, yearB] = b.split('/').map(Number);
                return new Date(yearA, monthA - 1, dayA) - new Date(yearB, monthB - 1, dayB);
            });
            const dados = labels.map(label => agendamentosPorDia[label]);

            const ctx = document.getElementById('agendamentosPorDiaChart').getContext('2d');
            if (window.agendamentosChart) {
                window.agendamentosChart.destroy();
            }
            window.agendamentosChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Agendamentos por Dia',
                        data: dados,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'N√∫mero de Agendamentos'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Data'
                            }
                        }
                    }
                }
            });

            const tbody = document.querySelector('#servicosPopularesTable tbody');
            tbody.innerHTML = '';
            const servicosOrdenados = Object.entries(servicosContagem).sort((a, b) => b[1] - a[1]);
            servicosOrdenados.forEach(([servico, quantidade]) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="border: 1px solid #ddd; padding: 8px;">${servico}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${quantidade}</td>
                `;
                tbody.appendChild(tr);
            });

            if (servicosOrdenados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; padding: 8px;">Nenhum dado encontrado.</td></tr>';
            }

            const totalDiv = document.getElementById('total-valor-servicos');
            totalDiv.innerHTML = `<h3>Total dos Servi√ßos: R$ ${totalValorServicos.toFixed(2)}</h3>`;
        }

        document.getElementById('gerar-relatorio-btn').addEventListener('click', async () => {
            const dataInicio = document.getElementById('relatorio-data-inicio').value;
            const dataFim = document.getElementById('relatorio-data-fim').value;
            await gerarRelatorios(dataInicio, dataFim);
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const isAdmin = await verificarRoleAdmin(user);
                if (isAdmin) {
                    adminContent.style.display = "block";
                    accessDenied.style.display = "none";
                    await carregarUsuarios();
                    const q = collection(db, "agendamentos");
                    onSnapshot(q, (querySnapshot) => {
                        agendamentosList = [];
                        querySnapshot.forEach((doc) =>
                            agendamentosList.push({ id: doc.id, ...doc.data() })
                        );
                        exibirAgendamentosAdmin(agendamentosList);
                    });
                } else {
                    adminContent.style.display = "none";
                    accessDenied.style.display = "block";
                }
            } else {
                window.location.href = "/index.html";
            }
        });

        document.addEventListener("DOMContentLoaded", () => {
            const logoutAdminBtn = document.getElementById("logout-admin-btn");
            if (logoutAdminBtn) {
                logoutAdminBtn.addEventListener("click", () => {
                    signOut(auth)
                        .then(() => {
                            window.location.href = "/AteliedasUnhas/";
                        })
                        .catch((error) => {
                            alert("Erro ao sair.");
                        });
                });
            }

            const aplicarFiltroBtn = document.getElementById("aplicar-filtro-btn");
            const limparFiltroBtn = document.getElementById("limpar-filtro-btn");

            if (aplicarFiltroBtn) {
                aplicarFiltroBtn.addEventListener("click", () => {
                    const dataInicio = document.getElementById("filtro-data-inicio").value;
                    const dataFim = document.getElementById("filtro-data-fim").value;
                    const nome = document.getElementById("filtro-nome").value.trim();

                    const filtros = {};
                    if (dataInicio) filtros.dataInicio = dataInicio;
                    if (dataFim) filtros.dataFim = dataFim;
                    if (nome) filtros.nome = nome;

                    exibirAgendamentosAdmin(agendamentosList, filtros);
                });
            }

            if (limparFiltroBtn) {
                limparFiltroBtn.addEventListener("click", () => {
                    document.getElementById("filtro-data-inicio").value = "";
                    document.getElementById("filtro-data-fim").value = "";
                    document.getElementById("filtro-nome").value = "";
                    exibirAgendamentosAdmin(agendamentosList);
                });
            }

            const bloquearDataBtn = document.getElementById("bloquear-data-btn");
            if (bloquearDataBtn) {
                bloquearDataBtn.addEventListener("click", async () => {
                    const dataBloqueio = document.getElementById("data-bloqueio").value;
                    if (!dataBloqueio) {
                        alert("Por favor, selecione uma data para bloquear.");
                        return;
                    }
                    await bloquearData(dataBloqueio);
                });
            }

            if (editarDataInput) {
                editarDataInput.addEventListener("change", async () => {
                    const dataSelecionada = editarDataInput.value;
                    if (dataSelecionada) {
                        const agendamentoId = editarAgendamentoIdInput.value;
                        const agendamento = agendamentosList.find(ag => ag.id === agendamentoId);
                        let duracaoTotal = 0;
                        if (agendamento && Array.isArray(agendamento.servicos)) {
                            duracaoTotal = agendamento.servicos.reduce((total, servico) => {
                                return total + (duracaoServicos[servico] || 60);
                            }, 0);
                        } else {
                            duracaoTotal = 60;
                        }
                        await atualizarHorariosDisponiveis(dataSelecionada, agendamentoId, duracaoTotal, false);
                    } else {
                        editarHorarioSelect.innerHTML = '<option value="">Selecione uma data primeiro</option>';
                        editarHorarioSelect.disabled = true;
                    }
                });
            }

            if (salvarEdicaoBtn) {
                salvarEdicaoBtn.addEventListener("click", async () => {
                    const agendamentoId = editarAgendamentoIdInput.value;
                    const dataSelecionada = editarDataInput.value;
                    const horarioSelecionado = editarHorarioSelect.value;
                    const novoStatus = editarStatusSelect.value;

                    if (!dataSelecionada || !horarioSelecionado) {
                        alert("Por favor, selecione uma data e um hor√°rio.");
                        return;
                    }

                    if (await isDataBloqueada(dataSelecionada)) {
                        alert("N√£o √© poss√≠vel editar o agendamento para uma data bloqueada.");
                        return;
                    }

                    const [hora, minuto] = horarioSelecionado.split(":").map(Number);
                    const [ano, mes, dia] = dataSelecionada.split("-").map(Number);
                    const novaData = new Date(ano, mes - 1, dia, hora, minuto, 0);

                    const agendamento = agendamentosList.find(ag => ag.id === agendamentoId);
                    let duracaoTotal = 0;
                    if (agendamento && Array.isArray(agendamento.servicos)) {
                        duracaoTotal = agendamento.servicos.reduce((total, servico) => {
                            return total + (duracaoServicos[servico] || 60);
                        }, 0);
                    } else {
                        duracaoTotal = 60;
                    }

                    const agendamentosNaData = await buscarAgendamentosPorData(novaData);
                    const fimAgendamento = new Date(novaData.getTime() + duracaoTotal * 60 * 1000);

                    const conflito = agendamentosNaData
                        .filter(ag => ag.id !== agendamentoId)
                        .some(agendamento => {
                            const inicioExistente = new Date(agendamento.data);
                            let duracaoExistente = 0;
                            if (Array.isArray(agendamento.servicos)) {
                                duracaoExistente = agendamento.servicos.reduce((total, servico) => {
                                    return total + (duracaoServicos[servico] || 60);
                                }, 0);
                            } else {
                                duracaoExistente = 60;
                            }
                            const fimExistente = new Date(inicioExistente.getTime() + duracaoExistente * 60 * 1000);
                            return (
                                (novaData < fimExistente && fimAgendamento > inicioExistente)
                            );
                        });

                    if (conflito) {
                        alert("O hor√°rio selecionado j√° est√° ocupado. Escolha outro hor√°rio.");
                        return;
                    }

                    try {
                        const agendamentoRef = doc(db, "agendamentos", agendamentoId);
                        await updateDoc(agendamentoRef, {
                            data: novaData.toISOString(),
                            status: novoStatus,
                        });

                        alert("Agendamento atualizado com sucesso!");
                        modalEdicao.style.display = "none";
                    } catch (error) {
                        console.error("Erro ao salvar agendamento:", error);
                        alert("Erro ao salvar o agendamento.");
                    }
                });
            }

            if (cancelarEdicaoBtn) {
                cancelarEdicaoBtn.addEventListener("click", () => {
                    modalEdicao.style.display = "none";
                });
            }

            if (closeButtonEdicao) {
                closeButtonEdicao.addEventListener("click", () => {
                    modalEdicao.style.display = "none";
                });
            }

            window.addEventListener("click", (event) => {
                if (event.target === modalEdicao) {
                    modalEdicao.style.display = "none";
                }
                if (event.target === modalNovoAgendamento) {
                    modalNovoAgendamento.style.display = "none";
                    formNovoAgendamento.reset();
                    const horarioSelect = document.getElementById("novo-horario");
                    horarioSelect.innerHTML = '<option value="">Selecione uma data primeiro</option>';
                }
            });

            async function atualizarHorariosNovoAgendamento() {
                const dataSelecionada = document.getElementById("novo-data").value;
                if (dataSelecionada) {
                    if (await isDataBloqueada(dataSelecionada)) {
                        const horarioSelect = document.getElementById("novo-horario");
                        horarioSelect.innerHTML = '<option value="">Data bloqueada</option>';
                        horarioSelect.disabled = true;
                        console.log("Data bloqueada para novo agendamento:", dataSelecionada);
                        return;
                    }

                    const servicosSelecionados = Array.from(
                        document.querySelectorAll(".novo-servico-checkbox:checked")
                    ).map(cb => cb.value);
                    if (servicosSelecionados.length === 0) {
                        const horarioSelect = document.getElementById("novo-horario");
                        horarioSelect.innerHTML = '<option value="">Selecione pelo menos um servi√ßo</option>';
                        horarioSelect.disabled = true;
                        return;
                    }
                    const duracaoTotal = servicosSelecionados.reduce((total, servico) => {
                        return total + (duracaoServicos[servico] || 60);
                    }, 0);
                    console.log("Dura√ß√£o total para novo agendamento:", duracaoTotal);
                    await atualizarHorariosDisponiveis(dataSelecionada, null, duracaoTotal, true);
                } else {
                    const horarioSelect = document.getElementById("novo-horario");
                    horarioSelect.innerHTML = '<option value="">Selecione uma data primeiro</option>';
                    horarioSelect.disabled = true;
                }
            }

            const novoDataInput = document.getElementById("novo-data");
            if (novoDataInput) {
                novoDataInput.addEventListener("change", async () => {
                    await atualizarHorariosNovoAgendamento();
                });
            }

            document.querySelectorAll(".novo-servico-checkbox").forEach(checkbox => {
                checkbox.addEventListener("change", async () => {
                    await atualizarHorariosNovoAgendamento();
                });
            });

            if (formNovoAgendamento) {
                formNovoAgendamento.addEventListener("submit", async (e) => {
                    e.preventDefault();

                    const usuarioUid = document.getElementById("novo-usuario").value;
                    const servicosSelecionados = Array.from(
                        document.querySelectorAll(".novo-servico-checkbox:checked")
                    ).map(cb => cb.value);
                    const dataSelecionada = document.getElementById("novo-data").value;
                    const horarioSelecionado = document.getElementById("novo-horario").value;

                    if (!usuarioUid) {
                        alert("Selecione um usu√°rio.");
                        return;
                    }
                    if (servicosSelecionados.length === 0) {
                        alert("Selecione pelo menos um servi√ßo.");
                        return;
                    }
                    if (!dataSelecionada || !horarioSelecionado) {
                        alert("Selecione uma data e um hor√°rio.");
                        return;
                    }

                    if (await isDataBloqueada(dataSelecionada)) {
                        alert("N√£o √© poss√≠vel criar um agendamento para uma data bloqueada.");
                        return;
                    }

                    const [hora, minuto] = horarioSelecionado.split(":").map(Number);
                    const [ano, mes, dia] = dataSelecionada.split("-").map(Number);
                    const dataAgendamento = new Date(ano, mes - 1, dia, hora, minuto, 0);

                    let duracaoTotal = 0;
                    servicosSelecionados.forEach(servico => {
                        duracaoTotal += duracaoServicos[servico] || 60;
                    });

                    const hoje = new Date();
                    if (dataAgendamento < hoje.setHours(0, 0, 0, 0)) {
                        alert("N√£o √© poss√≠vel agendar para uma data passada.");
                        return;
                    }

                    const agendamentosNaData = await buscarAgendamentosPorData(dataAgendamento);
                    const fimAgendamento = new Date(dataAgendamento.getTime() + duracaoTotal * 60 * 1000);

                    const conflito = agendamentosNaData.some(agendamento => {
                        const inicioExistente = new Date(agendamento.data);
                        let duracaoExistente = 0;
                        if (Array.isArray(agendamento.servicos)) {
                            duracaoExistente = agendamento.servicos.reduce((total, servico) => {
                                return total + (duracaoServicos[servico] || 60);
                            }, 0);
                        } else {
                            duracaoExistente = 60;
                        }
                        const fimExistente = new Date(inicioExistente.getTime() + duracaoExistente * 60 * 1000);
                        return (
                            (dataAgendamento < fimExistente && fimAgendamento > inicioExistente)
                        );
                    });

                    if (conflito) {
                        alert("O hor√°rio selecionado j√° est√° ocupado. Escolha outro hor√°rio.");
                        return;
                    }

                    try {
                        await addDoc(collection(db, "agendamentos"), {
                            uid: usuarioUid,
                            servicos: servicosSelecionados,
                            data: dataAgendamento.toISOString(),
                            status: "pendente",
                            confirmacaoEnviada: false,
                            createdAt: new Date().getTime(),
                        });

                        alert("Agendamento criado com sucesso!");
                        formNovoAgendamento.reset();
                        const horarioSelect = document.getElementById("novo-horario");
                        horarioSelect.innerHTML = '<option value="">Selecione uma data primeiro</option>';
                        modalNovoAgendamento.style.display = "none";
                    } catch (error) {
                        console.error("Erro ao criar agendamento:", error);
                        alert("Erro ao criar o agendamento.");
                    }
                });
            }

            const cancelarNovoBtn = document.getElementById("cancelar-novo-btn");
            if (cancelarNovoBtn) {
                cancelarNovoBtn.addEventListener("click", () => {
                    modalNovoAgendamento.style.display = "none";
                    formNovoAgendamento.reset();
                    const horarioSelect = document.getElementById("novo-horario");
                    horarioSelect.innerHTML = '<option value="">Selecione uma data primeiro</option>';
                });
            }

            const abrirNovoAgendamentoBtn = document.getElementById("abrir-novo-agendamento");
            if (abrirNovoAgendamentoBtn) {
                abrirNovoAgendamentoBtn.addEventListener("click", () => {
                    modalNovoAgendamento.style.display = "block";
                });
            }

            if (closeButtonNovo) {
                closeButtonNovo.addEventListener("click", () => {
                    modalNovoAgendamento.style.display = "none";
                    formNovoAgendamento.reset();
                    const horarioSelect = document.getElementById("novo-horario");
                    horarioSelect.innerHTML = '<option value="">Selecione uma data primeiro</option>';
                });
            }
        });
    </script>
</head>
<body>
<div id="admin-content" style="display: none;">
    <h1>Painel de Administra√ß√£o</h1>
    <button id="logout-admin-btn">Sair</button>

    <button id="abrir-novo-agendamento">Novo Agendamento</button>

    
    <div id="relatorios">
        <h2>Relat√≥rios</h2>
        <div style="margin-bottom: 20px;">
            <label for="relatorio-data-inicio">Data In√≠cio:</label>
            <input type="date" id="relatorio-data-inicio" />
            <label for="relatorio-data-fim">Data Fim:</label>
            <input type="date" id="relatorio-data-fim" />
            <button type="button" id="gerar-relatorio-btn">Gerar Relat√≥rio</button>
        </div>
        <div id="total-valor-servicos"></div>
        <div style="display: flex; flex-wrap: wrap; gap: 20px;">
            <div style="flex: 1; min-width: 300px;">
                <h3>Agendamentos por Dia</h3>
                <canvas id="agendamentosPorDiaChart" width="400" height="200"></canvas>
            </div>
            <div style="flex: 1; min-width: 300px;">
                <h3>Servi√ßos Mais Populares</h3>
                <table id="servicosPopularesTable" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="border: 1px solid #ddd; padding: 8px;">Servi√ßo</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">Quantidade</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <h2>Bloquear Data</h2>
    <div id="bloquear-data">
        <label for="data-bloqueio">Selecione a data a ser bloqueada:</label>
        <input type="date" id="data-bloqueio" />
        <button id="bloquear-data-btn">Bloquear Data</button>
    </div>
    <h2>Lista de Agendamentos</h2>
    <div id="filtro-agendamentos">
        <h3>Filtrar Agendamentos</h3>
        <form id="form-filtro-agendamentos">
            <div>
                <label for="filtro-data-inicio">Data In√≠cio:</label>
                <input type="date" id="filtro-data-inicio" />
            </div>
            <div>
                <label for="filtro-data-fim">Data Fim:</label>
                <input type="date" id="filtro-data-fim" />
            </div>
            <div>
                <label for="filtro-nome">Nome do Usu√°rio:</label>
                <input type="text" id="filtro-nome" placeholder="Digite o nome" />
            </div>
            <button type="button" id="aplicar-filtro-btn">Aplicar Filtro</button>
            <button type="button" id="limpar-filtro-btn">Limpar Filtro</button>
        </form>
    </div>
    
    <div id="lista-de-agendamentos-admin"></div>

<div id="modal-edicao" class="modal-edicao">
    <div class="modal-content-edicao">
        <span id="close-button-edicao" class="close-button-edicao">√ó</span>
        <div id="formulario-edicao-agendamento">
            <h3>Editar Agendamento</h3>
            <form id="form-editar-agendamento">
                <input type="hidden" id="editar-agendamento-id" />
                <div style="margin-bottom: 20px;">
                    <label for="editar-data" style="font-weight: bold;">üìÖ Data do Agendamento:</label><br />
                    <input type="date" id="editar-data" style="margin-top: 5px;" required />
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="editar-horario" style="font-weight: bold;">üïí Hor√°rio Dispon√≠vel:</label><br />
                    <select id="editar-horario" style="margin-top: 5px; padding: 5px;" required>
                        <option value="">Selecione uma data primeiro</option>
                    </select>
                </div>
                <div>
                    <label for="editar-status">Status:</label>
                    <select id="editar-status">
                        <option value="pendente">Pendente</option>
                        <option value="confirmado">Confirmado</option>
                    </select>
                </div>
                <button type="button" id="salvar-edicao-btn">Salvar Edi√ß√£o</button>
                <button type="button" id="cancelar-edicao-btn">Cancelar</button>
            </form>
        </div>
    </div>
</div>

<div id="modal-novo-agendamento" class="modal-novo-agendamento">
    <div class="modal-content-novo-agendamento">
        <span id="close-button-novo-agendamento" class="close-button-novo-agendamento">√ó</span>
        <div id="formulario-novo-agendamento">
            <h2>Novo Agendamento</h2>
            <form id="form-novo-agendamento">
                <div style="margin-bottom: 20px;">
                    <label for="novo-usuario">Usu√°rio:</label>
                    <select id="novo-usuario" required>
                        <option value="">Selecione um usu√°rio</option>
                    </select>
                </div>
                <div style="margin-bottom: 20px;">
                    <label>Servi√ßos:</label>
                    <div style="display: flex; flex-direction: column;">
                        <label><input type="checkbox" class="novo-servico-checkbox" value="Manicure - P√© e M√£o"> Manicure - P√© e M√£o</label>
                        <label><input type="checkbox" class="novo-servico-checkbox" value="Manicure - M√£o Simples"> Manicure - M√£o Simples</label>
                        <label><input type="checkbox" class="novo-servico-checkbox" value="P√© Simples"> P√© Simples</label>
                        <label><input type="checkbox" class="novo-servico-checkbox" value="ESMALTA√á√ÉO EM GEL C/ Cutilagem"> ESMALTA√á√ÉO EM GEL C/ Cutilagem</label>
                        <label><input type="checkbox" class="novo-servico-checkbox" value="Esmalta√ß√£o M√£o"> Esmalta√ß√£o M√£o</label>
                        <label><input type="checkbox" class="novo-servico-checkbox" value="Alongamento Speed Tip Gel"> Alongamento Speed Tip Gel</label>
                        <label><input type="checkbox" class="novo-servico-checkbox" value="PL√ÅSTICA DOS P√âS"> PL√ÅSTICA DOS P√âS</label>
                        <label><input type="checkbox" class="novo-servico-checkbox" value="Aplica√ß√£o Unha Posti√ßa"> Aplica√ß√£o Unha Posti√ßa</label>
                        <label><input type="checkbox" class="novo-servico-checkbox" value="SPA DOS P√âS"> SPA DOS P√âS</label>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="novo-data">Data:</label>
                    <input type="date" id="novo-data" required />
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="novo-horario">Hor√°rio:</label>
                    <select id="novo-horario" required>
                        <option value="">Selecione uma data primeiro</option>
                    </select>
                </div>
                <button type="submit">Criar Agendamento</button>
                <button type="button" id="cancelar-novo-btn">Cancelar</button>
            </form>
        </div>
    </div>
</div>

<div id="access-denied" style="display: none;">
    <h1>Acesso Negado</h1>
    <p>Voc√™ n√£o tem permiss√£o para acessar esta p√°gina.</p>
    <p><a href="/index.html">Voltar para a p√°gina inicial</a></p>
</div>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9380e95bdbd553df',t:'MTc0NTk1MTg1Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>