<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel de Administra√ß√£o</title>
    <link rel="stylesheet" href="styles.css" />
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        query,
        where,
        getDocs,
        onSnapshot,
        doc,
        updateDoc,
        deleteDoc,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
    
      const firebaseConfig = {
        apiKey: "AIzaSyD2abLi_zEjHPS0D8EvcDPYLIbOhQa68p8",
        authDomain: "projeto3-9bb85.firebaseapp.com",
        projectId: "projeto3-9bb85",
        storageBucket: "projeto3-9bb85.firebasestorage.app",
        messagingSenderId: "403757642546",
        appId: "1:403757642546:web:b2093665bce9099b6fdd2b",
      };
    
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
    
      const adminContent = document.getElementById("admin-content");
      const accessDenied = document.getElementById("access-denied");
      const listaDeAgendamentosAdminDiv = document.getElementById(
        "lista-de-agendamentos-admin"
      );
      const formularioEdicaoAgendamentoDiv = document.getElementById(
        "formulario-edicao-agendamento"
      );
      const formEditarAgendamento = document.getElementById(
        "form-editar-agendamento"
      );
      const editarAgendamentoIdInput = document.getElementById(
        "editar-agendamento-id"
      );
      const editarDataInput = document.getElementById("editar-data");
      const editarStatusSelect = document.getElementById("editar-status");
      const salvarEdicaoBtn = document.getElementById("salvar-edicao-btn");
      const cancelarEdicaoBtn = document.getElementById("cancelar-edicao-btn");
    
      let agendamentosList = [];
    
      async function verificarRoleAdmin(user) {
        if (user) {
          const userDocSnapshot = await getDocs(
            query(collection(db, "users"), where("uid", "==", user.uid))
          );
          if (!userDocSnapshot.empty) {
            const userData = userDocSnapshot.docs[0].data();
            return userData.isAdmin === true;
          }
        }
        return false;
      }
    
      async function exibirAgendamentosAdmin(agendamentos) {
        listaDeAgendamentosAdminDiv.innerHTML = "";
    
        if (agendamentos && Array.isArray(agendamentos) && agendamentos.length > 0) {
          agendamentos.sort((a, b) => {
            const dateA = new Date(a.data);
            const dateB = new Date(b.data);
            return dateA - dateB;
          });
    
          for (const agendamento of agendamentos) {
            try {
              const userDoc = await getDocs(
                query(collection(db, "users"), where("uid", "==", agendamento.uid))
              );
    
              let nomeUsuario = "N√£o encontrado";
              let telefoneUsuario = "N√£o encontrado";
    
              if (!userDoc.empty) {
                const userData = userDoc.docs[0].data();
                nomeUsuario = userData.displayName || "N√£o informado";
                telefoneUsuario = userData.phone || "N√£o informado";
              }
    
              const dataAgendada = new Date(agendamento.data);
              const dataFormatada = dataAgendada.toLocaleDateString("pt-BR", {
                day: "2-digit",
                month: "2-digit",
                year: "numeric",
                hour: "2-digit",
                minute: "2-digit",
              });
    
              const servicos = Array.isArray(agendamento.servicos)
                ? agendamento.servicos.join(", ")
                : "Nenhum servi√ßo selecionado";
    
              const agendamentoDiv = document.createElement("div");
              agendamentoDiv.classList.add("agendamento-item");
              agendamentoDiv.innerHTML = `
                <p><strong>Nome do Usu√°rio:</strong> ${nomeUsuario}</p>
                <p><strong>Telefone do Usu√°rio:</strong> ${telefoneUsuario}</p>
                <p><strong>Servi√ßos:</strong> ${servicos}</p>
                <p><strong>Data e Hora:</strong> ${dataFormatada}</p>
              `;
    
              if (!agendamento.confirmacaoEnviada) {
                agendamentoDiv.innerHTML += `
                  <button class="whatsapp-btn"
                    data-id="${agendamento.id}"
                    data-nome="${nomeUsuario}"
                    data-telefone="${telefoneUsuario}"
                    data-servicos="${servicos}"
                    data-data="${dataFormatada}">
                    Enviar Confirma√ß√£o por WhatsApp
                  </button>
                `;
              } else {
                agendamentoDiv.innerHTML += `<p>Confirma√ß√£o j√° enviada.</p>`;
              }
    
              agendamentoDiv.innerHTML += `
                <button class="editar-btn" data-id="${agendamento.id}" data-nome="${nomeUsuario}" data-servicos="${servicos}" data-data="${dataFormatada}">
                  Editar
                </button>
                <button class="excluir-btn" data-id="${agendamento.id}">
                  Excluir
                </button>
                <hr>
              `;
    
              listaDeAgendamentosAdminDiv.appendChild(agendamentoDiv);
            } catch (error) {
              console.error("Erro ao buscar dados do usu√°rio:", error);
            }
          }
    
          // Lidar com o clique no bot√£o de "Editar"
          document.querySelectorAll(".editar-btn").forEach((botao) => {
            botao.addEventListener("click", (event) => {
              const agendamentoId = event.target.dataset.id;
              const nome = event.target.dataset.nome;
              const servicos = event.target.dataset.servicos;
              const data = event.target.dataset.data;
    
              editarAgendamentoIdInput.value = agendamentoId;
              editarDataInput.value = new Date(data).toISOString().slice(0, 16);
              editarStatusSelect.value = "pendente"; // Defina o status conforme a l√≥gica do seu sistema
    
              formularioEdicaoAgendamentoDiv.style.display = "block";
            });
          });
    
          // Lidar com o clique no bot√£o de "Excluir"
          document.querySelectorAll(".excluir-btn").forEach((botao) => {
            botao.addEventListener("click", async (event) => {
              const agendamentoId = event.target.dataset.id;
    
              if (confirm("Tem certeza de que deseja excluir este agendamento?")) {
                try {
                  const agendamentoRef = doc(db, "agendamentos", agendamentoId);
                  await deleteDoc(agendamentoRef); // Fun√ß√£o para excluir o documento
                  alert("Agendamento exclu√≠do com sucesso!");
                } catch (error) {
                  console.error("Erro ao excluir o agendamento:", error);
                  alert("Erro ao excluir o agendamento.");
                }
              }
            });
          });
    
          // Bot√£o do WhatsApp
          document.querySelectorAll(".whatsapp-btn").forEach((botao) => {
            botao.addEventListener("click", async () => {
              const nome = botao.dataset.nome;
              const telefone = botao.dataset.telefone.replace(/\D/g, "");
              const servicos = botao.dataset.servicos;
              const data = botao.dataset.data;
              const agendamentoId = botao.dataset.id;
    
              const mensagem = `Ol√° ${nome}, tudo bem? üëã\n\n Seu agendamento em Ateli√™ das Unhas foi confirmado!\nüìÖ Data: ${data}\nüíº Servi√ßos: ${servicos}\n\nQualquer d√∫vida, estamos √† disposi√ß√£o.üíÖ`;
              const url = `https://wa.me/55${telefone}?text=${encodeURIComponent(mensagem)}`;
              window.open(url, "_blank");
    
              try {
                const agendamentoRef = doc(db, "agendamentos", agendamentoId);
                await updateDoc(agendamentoRef, {
                  confirmacaoEnviada: true,
                });
                console.log("Confirma√ß√£o enviada com sucesso!");
              } catch (error) {
                console.error("Erro ao atualizar o status de confirma√ß√£o:", error);
              }
            });
          });
        } else {
          listaDeAgendamentosAdminDiv.innerHTML = "<p>Nenhum agendamento encontrado.</p>";
        }
      }
    
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const isAdmin = await verificarRoleAdmin(user);
          if (isAdmin) {
            adminContent.style.display = "block";
            accessDenied.style.display = "none";
            const q = collection(db, "agendamentos");
            onSnapshot(q, (querySnapshot) => {
              agendamentosList = [];
              querySnapshot.forEach((doc) =>
                agendamentosList.push({ id: doc.id, ...doc.data() })
              );
              exibirAgendamentosAdmin(agendamentosList);
            });
          } else {
            adminContent.style.display = "none";
            accessDenied.style.display = "block";
          }
        } else {
          window.location.href = "/index.html";
        }
      });
    
      document.addEventListener("DOMContentLoaded", () => {
        const logoutAdminBtn = document.getElementById("logout-admin-btn");
        if (logoutAdminBtn) {
          logoutAdminBtn.addEventListener("click", () => {
            signOut(auth)
              .then(() => {
                window.location.href = "/AteliedasUnhas/";
              })
              .catch((error) => {
                alert("Erro ao sair.");
              });
          });
        }
    
        if (salvarEdicaoBtn) {
          salvarEdicaoBtn.addEventListener("click", async () => {
            const agendamentoId = editarAgendamentoIdInput.value;
            const novaDataHora = editarDataInput.value;
            const novoStatus = editarStatusSelect.value;
    
            if (agendamentoId) {
              try {
                const agendamentoRef = doc(db, "agendamentos", agendamentoId);
                await updateDoc(agendamentoRef, {
                  data: new Date(novaDataHora).getTime(),
                  status: novoStatus,
                });
                formularioEdicaoAgendamentoDiv.style.display = "none";
              } catch (error) {
                alert("Erro ao atualizar o agendamento.");
              }
            }
          });
        }
    
        if (cancelarEdicaoBtn) {
          cancelarEdicaoBtn.addEventListener("click", () => {
            formularioEdicaoAgendamentoDiv.style.display = "none";
          });
        }
      });
    </script>
  </head>
  <body>
    <div id="admin-content">
      <h1>Painel de Administra√ß√£o</h1>
      <button id="logout-admin-btn">Logout</button>
      <h2>Agendamentos Realizados</h2>
      <div id="lista-de-agendamentos-admin"></div>
      <div id="formulario-edicao-agendamento">
        <h2>Editar Agendamento</h2>
        <form id="form-editar-agendamento">
          <input type="hidden" id="editar-agendamento-id" />
          <div>
            <label for="editar-data">Data e Hora:</label>
            <input type="datetime-local" id="editar-data" />
          </div>
          <div>
            <label for="editar-status">Status:</label>
            <select id="editar-status">
              <option value="pendente">Pendente</option>
              <option value="confirmado">Confirmado</option>
              <option value="cancelado">Cancelado</option>
              <option value="concluido">Conclu√≠do</option>
            </select>
          </div>
          <button type="button" id="salvar-edicao-btn">Salvar Edi√ß√£o</button>
          <button type="button" id="cancelar-edicao-btn">Cancelar</button>
        </form>
      </div>
    </div>
    <div id="access-denied">
      <h2>Acesso Negado</h2>
      <p>Voc√™ n√£o tem permiss√£o para acessar esta p√°gina.</p>
    </div>
  </body>
</html>
