<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel de Administra√ß√£o</title>
    <link rel="stylesheet" href="styles.css" />
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
      import {
       getAuth,
       onAuthStateChanged,
       signOut,
      } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
      import {
       getFirestore,
       collection,
       query,
       where,
       getDocs,
       onSnapshot,
       doc,
       updateDoc,
       orderBy, // Importe a fun√ß√£o orderBy
      } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
    
      // Sua configura√ß√£o do Firebase
      const firebaseConfig = {
       apiKey: "AIzaSyD2abLi_zEjHPS0D8EvcDPYLIbOhQa68p8",
       authDomain: "projeto3-9bb85.firebaseapp.com",
       projectId: "projeto3-9bb85",
       storageBucket: "projeto3-9bb85.firebasestorage.app",
       messagingSenderId: "403757642546",
       appId: "1:403757642546:web:b2093665bce9099b6fdd2b",
      };
    
      // Inicializa o Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
    
      // Elementos do DOM
      const adminContent = document.getElementById("admin-content");
      const accessDenied = document.getElementById("access-denied");
      const listaDeAgendamentosAdminDiv = document.getElementById(
       "lista-de-agendamentos-admin"
      );
      const formularioEdicaoAgendamentoDiv = document.getElementById(
       "formulario-edicao-agendamento"
      );
      const formEditarAgendamento = document.getElementById(
       "form-editar-agendamento"
      );
      const editarAgendamentoIdInput = document.getElementById(
       "editar-agendamento-id"
      );
      const editarDataInput = document.getElementById("editar-data");
      const editarStatusSelect = document.getElementById("editar-status");
      const salvarEdicaoBtn = document.getElementById("salvar-edicao-btn");
      const cancelarEdicaoBtn = document.getElementById("cancelar-edicao-btn");
    
      let agendamentosList = []; // Vari√°vel para armazenar a lista de agendamentos
    
      // Fun√ß√£o para verificar a role do usu√°rio
      async function verificarRoleAdmin(user) {
       if (user) {
        const userDocSnapshot = await getDocs(
         query(collection(db, "users"), where("uid", "==", user.uid))
        );
        if (!userDocSnapshot.empty) {
         const userData = userDocSnapshot.docs[0].data();
         return userData.isAdmin === true; // Verifica o campo isAdmin
        }
       }
       return false;
      }
    
      // Fun√ß√£o para exibir os agendamentos
      async function exibirAgendamentosAdmin(agendamentos) {
       listaDeAgendamentosAdminDiv.innerHTML = ""; // Limpar a lista antes de exibir os agendamentos
    
       if (agendamentos && Array.isArray(agendamentos) && agendamentos.length > 0) {
        // Ordenar os agendamentos por data e hora
        agendamentos.sort((a, b) => {
         const dateA = new Date(a.data);
         const dateB = new Date(b.data);
         return dateA - dateB; // Ordena cronologicamente (do mais antigo para o mais recente)
        });
    
        for (const agendamento of agendamentos) {
         try {
          // Recuperar os dados do usu√°rio associado ao agendamento
          const userDoc = await getDocs(
           query(collection(db, "users"), where("uid", "==", agendamento.uid))
          );
    
          let nomeUsuario = "N√£o encontrado";
          let telefoneUsuario = "N√£o encontrado";
    
          if (!userDoc.empty) {
           const userData = userDoc.docs[0].data();
           nomeUsuario = userData.displayName || "N√£o informado";
           telefoneUsuario = userData.phone || "N√£o informado";
          }
    
          const dataAgendada = new Date(agendamento.data);
          const dataFormatada = dataAgendada.toLocaleDateString("pt-BR", {
           day: "2-digit",
           month: "2-digit",
           year: "numeric",
           hour: "2-digit",
           minute: "2-digit",
          });
    
          const servicos = Array.isArray(agendamento.servicos)
           ? agendamento.servicos.join(", ")
           : "Nenhum servi√ßo selecionado";
    
          const agendamentoDiv = document.createElement("div");
          agendamentoDiv.classList.add("agendamento-item");
          agendamentoDiv.innerHTML = `
           <p><strong>Nome do Usu√°rio:</strong> ${nomeUsuario}</p>
           <p><strong>Telefone do Usu√°rio:</strong> ${telefoneUsuario}</p>
           <p><strong>Servi√ßos:</strong> ${servicos}</p>
           <p><strong>Data e Hora:</strong> ${dataFormatada}</p>
           <button class="editar-agendamento-btn" data-id="${agendamento.id}">Editar</button>
           <button class="whatsapp-btn"
            data-nome="${nomeUsuario}"
            data-telefone="${telefoneUsuario}"
            data-servicos="${servicos}"
            data-data="${dataFormatada}">
            Enviar Confirma√ß√£o por WhatsApp
           </button>
           <hr>
          `;
          listaDeAgendamentosAdminDiv.appendChild(agendamentoDiv);
         } catch (error) {
          console.error("Erro ao buscar dados do usu√°rio:", error);
         }
        }
    
        // Adicionar os eventos de clique para os bot√µes do WhatsApp
        document.querySelectorAll(".whatsapp-btn").forEach((botao) => {
         botao.addEventListener("click", () => {
          const nome = botao.dataset.nome;
          const telefone = botao.dataset.telefone.replace(/\D/g, ""); // Limpar caracteres n√£o num√©ricos
          const servicos = botao.dataset.servicos;
          const data = botao.dataset.data;
    
          const mensagem = `Ol√° ${nome}, tudo bem? üëã\n\n Seu agendamento em Ateli√™ das Unhas foi confirmado!\nüìÖ Data: ${data}\nüíº Servi√ßos: ${servicos}\n\nQualquer d√∫vida, estamos √† disposi√ß√£o.üíÖ`;
          const url = `https://wa.me/55${telefone}?text=${encodeURIComponent(mensagem)}`;
          window.open(url, "_blank");
          console.log(mensagem);  // Verifique se o emoji est√° na string
         });
        });
    
        // Adicionar os eventos de clique para os bot√µes de edi√ß√£o
        document.querySelectorAll(".editar-agendamento-btn").forEach((botao) => {
         botao.addEventListener("click", exibirFormularioEdicao);
        });
    
       } else {
        listaDeAgendamentosAdminDiv.innerHTML = "<p>Nenhum agendamento encontrado.</p>";
       }
      }
    
      function exibirFormularioEdicao(event) {
       const agendamentoId = event.target.dataset.id;
       console.log("ID do agendamento clicado:", agendamentoId);
       const agendamentoParaEditar = agendamentosList.find(
        (agendamento) => agendamento.id === agendamentoId
       );
       console.log("Agendamento encontrado:", agendamentoParaEditar);
    
       if (agendamentoParaEditar) {
        formularioEdicaoAgendamentoDiv.style.display = "block";
        formularioEdicaoAgendamentoDiv.style.position = "fixed";
        formularioEdicaoAgendamentoDiv.style.top = "50%";
        formularioEdicaoAgendamentoDiv.style.left = "50%";
        formularioEdicaoAgendamentoDiv.style.transform =
         "translate(-50%, -50%)";
        formularioEdicaoAgendamentoDiv.style.border = "2px solid blue"; // Adicione uma borda para visualiza√ß√£o
        editarAgendamentoIdInput.value = agendamentoId;
        editarDataInput.value = new Date(agendamentoParaEditar.data)
         .toISOString()
         .slice(0, 16);
        editarStatusSelect.value = agendamentoParaEditar.status;
       }
      }
    
      async function salvarEdicaoAgendamento() {
       const agendamentoId = editarAgendamentoIdInput.value;
       const novaDataHora = editarDataInput.value;
       const novoStatus = editarStatusSelect.value;
    
       if (agendamentoId) {
        try {
         const agendamentoRef = doc(db, "agendamentos", agendamentoId);
         await updateDoc(agendamentoRef, {
          data: new Date(novaDataHora).getTime(), // Salva como timestamp
          status: novoStatus,
         });
         formularioEdicaoAgendamentoDiv.style.display = "none"; // Oculta o formul√°rio ap√≥s salvar
         console.log(
          `Agendamento com ID ${agendamentoId} atualizado com sucesso.`
         );
        } catch (error) {
         console.error("Erro ao atualizar agendamento:", error);
         alert("Erro ao atualizar o agendamento.");
        }
       }
      }
    
      // Listener para o estado de autentica√ß√£o
      onAuthStateChanged(auth, async (user) => {
       if (user) {
        const isAdmin = await verificarRoleAdmin(user);
        if (isAdmin) {
         adminContent.style.display = "block";
         accessDenied.style.display = "none";
         console.log("Acesso concedido: Administrador logado.");
    
         // Buscar e exibir os agendamentos de todos os usu√°rios
         const q = collection(db, "agendamentos");
         onSnapshot(q, (querySnapshot) => {
          agendamentosList = [];
          querySnapshot.forEach((doc) =>
           agendamentosList.push({ id: doc.id, ...doc.data() })
          );
          console.log("agendamentosList:", agendamentosList); // LOG ADICIONADO
          exibirAgendamentosAdmin(agendamentosList);
         });
        } else {
         adminContent.style.display = "none";
         accessDenied.style.display = "block";
         console.log("Acesso negado: Usu√°rio n√£o √© administrador.");
        }
       } else {
        console.log(
         "Acesso negado: Usu√°rio n√£o autenticado. Redirecionando para login."
        );
        window.location.href = "/index.html";
       }
      });
    
      document.addEventListener("DOMContentLoaded", () => {
       const logoutAdminBtn = document.getElementById("logout-admin-btn");
       if (logoutAdminBtn) {
        logoutAdminBtn.addEventListener("click", () => {
         signOut(auth)
          .then(() => {
           console.log("Usu√°rio deslogado.");
           window.location.href = "/AteliedasUnhas/";
          })
          .catch((error) => {
           console.error("Erro ao sair:", error);
           alert("Erro ao sair.");
          });
        });
       }
    
       // Event listeners para os bot√µes de salvar e cancelar edi√ß√£o
       if (salvarEdicaoBtn) {
        salvarEdicaoBtn.addEventListener("click", salvarEdicaoAgendamento);
       }
       if (cancelarEdicaoBtn) {
        cancelarEdicaoBtn.addEventListener("click", () => {
         formularioEdicaoAgendamentoDiv.style.display = "none"; // Oculta o formul√°rio ao cancelar
        });
       }
      });
     </script>
  </head>
  <body>
    <div id="admin-content">
      <h1>Painel de Administra√ß√£o</h1>
      <p>Bem-vindo ao painel de administra√ß√£o!</p>
      <button id="logout-admin-btn">Logout</button>

      <h2>Agendamentos Realizados</h2>
      <div id="lista-de-agendamentos-admin"></div>

      <div id="formulario-edicao-agendamento">
        <h2>Editar Agendamento</h2>
        <form id="form-editar-agendamento">
          <input type="hidden" id="editar-agendamento-id" />

          <div>
            <label for="editar-data">Data e Hora:</label>
            <input type="datetime-local" id="editar-data" />
          </div>

          <div>
            <label for="editar-status">Status:</label>
            <select id="editar-status">
              <option value="pendente">Pendente</option>
              <option value="confirmado">Confirmado</option>
              <option value="cancelado">Cancelado</option>
              <option value="concluido">Conclu√≠do</option>
            </select>
          </div>

          <button type="button" id="salvar-edicao-btn">Salvar Edi√ß√£o</button>
          <button type="button" id="cancelar-edicao-btn">Cancelar</button>
        </form>
      </div>
    </div>
    <div id="access-denied">
      <h2>Acesso Negado</h2>
      <p>Voc√™ n√£o tem permiss√£o para acessar esta p√°gina.</p>
      <p>Voc√™ ser√° redirecionado em breve...</p>
    </div>
  </body>
</html>
